---
- name: "Reload systemd configuration"
  command: systemctl daemon-reload
  when: init_template == 'systemd_template.j2'

- name: "Ensure required services are started"
  service: name={{ item }} state=restarted
  with_items:
    - neutron-server
    - neutron-linuxbridge-agent
    - neutron-dhcp-agent

- name : "Wait until neutron startup"
  pause:
    minutes: 1

- name: "If in noauth mode, unset authentication parameters."
  set_fact:
    auth_type: None
    auth: {}
  when: noauth_mode is defined and noauth_mode | bool == true

- name: "Execute os_client_config to collect facts"
  os_client_config:
  no_log: yes

# NOTE(TheJulia): The first record returned by os_client_config
# is utilized as the default. A user can still define the parameters
# if so desired.
- name: "Set os_client_config's auth parameters if not already set."
  set_fact:
    auth: "{{ openstack.clouds[0].auth }}"
    auth_type: "{{ openstack.clouds[0].auth_type }}"
  when: auth is undefined
  no_log: yes

- name: "Create neutron network"
  os_network:
    cloud: "{{ cloud_name | default(omit) }}"
    auth_type: "{{ auth_type | default(omit) }}"
    auth:
      auth_url: "{{ ironic.service_catalog.auth_url | default('http://127.0.0.1:5000/') }}/"
      username: "{{ keystone.bootstrap.username }}"
      password: "{{ keystone.bootstrap.password }}"
      project_name: "admin"
      project_domain_id: "default"
      user_domain_id: "default"
    endpoint_type: internal
    state: present
    name: baremetal
    provider_network_type: flat
    provider_physical_network: baremetal
    external: false
    shared: true
  environment:
    OS_IDENTITY_API_VERSION: "3"

- name: "Create neutron subnet"
  os_subnet:
    cloud: "{{ cloud_name | default(omit) }}"
    auth_type: "{{ auth_type | default(omit) }}"
    auth:
      auth_url: "{{ ironic.service_catalog.auth_url | default('http://127.0.0.1:5000/') }}/"
      username: "{{ keystone.bootstrap.username }}"
      password: "{{ keystone.bootstrap.password }}"
      project_name: "admin"
      project_domain_id: "default"
      user_domain_id: "default"
    endpoint_type: internal
    state: present
    name: baremetal
    network_name: baremetal
    cidr: "{{ neutron_network.cidr }}"
    gateway_ip: "{{ neutron_network.gateway }}"
    allocation_pool_start: "{{ neutron_network.allocation_pool_start }}"
    allocation_pool_end: "{{ neutron_network.allocation_pool_end }}"
    dns_nameservers: "{{ neutron_network.dns_nameservers }}"
  environment:
    OS_IDENTITY_API_VERSION: "3"
